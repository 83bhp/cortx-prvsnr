{
  "variables": {
    "mgmt_if": "lo",
    "data_if": "lo",
    "mgmt_device": "/dev/sda",
    "data_device": "/dev/sdb",
    "prvsnr_cli_release": "integration/last_successful",
    "prvsnr_release": "integration/last_successful",
    "eos_release": "integration/last_successful"
  },
  "builders": [
    {
      "type"                : "vagrant",
      "provider"            : "virtualbox",
      "source_path"         : "{{template_dir}}/../../.boxes/centos7-base/package.box",
      "add_force"           : true,
      "box_name"            : "seagate.ees-prvsnr.centos7-base",
      "template"            : "{{template_dir}}/vagrantfile.packer.template",
      "output_dir"          : "{{template_dir}}/../../.boxes/centos7-singlenode-bvt-ready",
      "output_vagrantfile"  : "{{template_dir}}/vagrantfile.eos.boxed",
      "package_include"     : [
          "{{template_dir}}/../../test/id_rsa.test"
      ],
      "communicator"        : "ssh"
    }
  ],
  "provisioners": [
    {
     "type": "file",
     "source": "{{template_dir}}/../../images/vagrant/setup_pillar_singlenode.sh",
     "destination": "/tmp/"
    },
    {
      "type": "shell",
      "inline": [
        "set -ex",
        "echo -e '[eos-prvsnr-cli]\ngpgcheck=0\nenabled=0\nbaseurl=http://ci-storage.mero.colo.seagate.com/releases/eos/{{user `prvsnr_cli_release`}}\nname=eos-prvsnr-cli' >/etc/yum.repos.d/eos-prvsnr-cli.repo",
        "yum --enablerepo=eos-prvsnr-cli install -y eos-prvsnr-cli",
        "cd /opt/seagate/eos-prvsnr/cli",
        "bash ./setup-provisioner -S -vv --repo-src rpm \"{{user `prvsnr_release`}}\"",
        "bash /tmp/setup_pillar_singlenode.sh \"{{user `mgmt_if`}}\" \"{{user `data_if`}}\"  \"{{user `mgmt_device`}}\" \"{{user `data_device`}}\" \"{{user `eos_release`}}\"",
        "sed -i 's/salt eosnode-1 state.highstate/salt -t 600 eosnode-1 state.highstate/g' deploy-eos",
        "sed -i 's/python36/python3/g' /opt/seagate/eos-prvsnr/srv/components/system/install.sls",
        "bash ./deploy-eos -S -vv",
        "sed -i 's/python36/python3/g' /opt/seagate/eos-prvsnr/srv/components/s3clients/awscli/install.sls",
        "salt eosnode-1 state.apply components.s3clients",
        "rm -f /tmp/setup_pillar_singlenode.sh"
      ]
    }
  ]
}
