{
  "variables": {
    "mgmt_if": "lo",
    "data_if": "lo",
    "prvsnr_src": "rpm",
    "prvsnr_release": "integration/last_successful",
    "eos_release": "integration/last_successful"
  },
  "builders": [
    {
      "type"                : "vagrant",
      "provider"            : "virtualbox",
      "source_path"         : "{{template_dir}}/../../.boxes/centos7-salt-installed/package.box",
      "add_force"           : true,
      "box_name"            : "seagate.ees-prvsnr.centos7-salt-installed",
      "template"            : "{{template_dir}}/vagrantfile.packer.template",
      "output_dir"          : "{{template_dir}}/../../.boxes/centos7-singlenode-deploy-ready",
      "output_vagrantfile"  : "{{template_dir}}/vagrantfile.eos.boxed",
      "package_include"     : [
          "{{template_dir}}/../../test/id_rsa.test"
      ],
      "communicator"        : "ssh"
    }
  ],
  "provisioners": [
    {
      "type": "shell-local",
      "inline": [
        "cd {{template_dir}}/../..",
        "mkdir -p .build",
        "rm -f .build/repo.tgz",
        "tar -czf .build/repo.tgz --exclude=.build --exclude=.boxes --exclude=.vdisks --exclude=.vagrant --exclude=.pytest_cache --exclude=__pycache__ --exclude=.git ."
      ]
    },
    {
     "type": "file",
     "source": "{{template_dir}}/../../.build/repo.tgz",
     "destination": "/tmp/",
     "generated": true
    },
    {
      "type": "shell",
      "inline": [
        "set -ex",
        "mkdir -p /tmp/ees-prvsnr",
        "tar -zxf /tmp/repo.tgz -C /tmp/ees-prvsnr",
        "cd /tmp/ees-prvsnr/cli/src",
        "bash ../../images/vagrant/setup_prvsnr_singlenode.sh \"{{user `prvsnr_src`}}\" \"{{user `prvsnr_release`}}\"",
        "bash ../../images/vagrant/setup_pillar_singlenode.sh \"{{user `mgmt_if`}}\" \"{{user `data_if`}}\" '' '' \"{{user `eos_release`}}\"",
        "rm -f /tmp/repo.tgz"
      ]
    }
  ]
}
