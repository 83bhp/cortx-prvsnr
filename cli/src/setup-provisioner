#!/bin/bash

function usage {
  echo "\
Usage: $0 [ees-prvsnr-tag]
defaults:
    - ees-prvsnr-tag: latest tagged
"
}

if [ "$1" = "--help" ]; then
    usage
    exit 0
fi

set -eu

SCRIPT_PATH=$(readlink -f "$0")
BASEDIR=$(dirname "$SCRIPT_PATH")
INSTALLDIR="/opt/seagate/ees-prvsnr"
EES_PRVSNR_REPO_API_TAGS='http://gitlab.mero.colo.seagate.com/api/v4/projects/eos%2Fprovisioner%2Fees-prvsnr/repository/tags?order_by=updated&sort=desc'

prvsnr_version="${1:-}"

# TODO replace with eos-provisioner.rpm installation
if [ ! -d "$INSTALLDIR" ]; then
    if [ -z "$prvsnr_version" ]; then
        _tags=$(curl "$EES_PRVSNR_REPO_API_TAGS")
        prvsnr_version=$(echo "$_tags" | tr ',' '\n' | sed -n 's/.*"name":"\(.\+\)".*/\1/p' | head -n1)
    fi

    if [ -z "$prvsnr_version" ]; then
        >&2 echo 'Version of the provisioner repo is unknown'
        exit 1
    fi

    mkdir -p "$INSTALLDIR"
    pushd "$INSTALLDIR"
        curl "http://gitlab.mero.colo.seagate.com/eos/provisioner/ees-prvsnr/-/archive/${prvsnr_version}/${prvsnr_version}.tar.gz" | tar xzf - --strip-components=1
    popd
fi

pushd "$INSTALLDIR"

    # config custom yum repos
    rm -rf /var/cache/yum
    rm -rf /etc/yum.repos.d
    cp -R files/etc/yum.repos.d /etc

    # install salt
    yum install -y salt-minion

    # re-config and restart salt
    mv -f /etc/salt/minion /etc/salt/minion.org
    cp files/etc/salt/minion /etc/salt/minion
    systemctl restart salt-minion

    # ensure it works and log the version
    salt-call --version

popd

echo "Done"
