#!/bin/sh

DEF_EES_PRVSNR_VERSION="ees1.0.0-PI.2-sprint5"

function usage {
  echo "\
Usage: $0 [ees-prvsnr-tag]
defaults:
    - ees-prvsnr-tag: '${DEF_EES_PRVSNR_VERSION}'
"
}

if [ "$1" = "--help" ]; then
    usage
    exit 0
fi

set -eu

SCRIPT_PATH=$(readlink -f "$0")
BASEDIR=$(dirname "$SCRIPT_PATH")
INSTALLDIR="/opt/seagate/ees-prvsnr"

prvsnr_version="${1:-$DEF_EES_PRVSNR_VERSION}"

# TODO replace with eos-provisioner.rpm installation
if [ ! -d "$INSTALLDIR" ]; then
    mkdir -p "$INSTALLDIR"
    pushd "$INSTALLDIR"
        curl "http://gitlab.mero.colo.seagate.com/eos/provisioner/ees-prvsnr/-/archive/${prvsnr_version}/${prvsnr_version}.tar.gz" | tar xzf - --strip-components=1
    popd
fi

pushd "$INSTALLDIR"

    # config custom yum repos
    rm -rf /var/cache/yum
    rm -rf /etc/yum.repos.d
    cp -R files/etc/yum.repos.d /etc

    # install salt
    yum install -y salt-minion

    # re-config and restart salt
    mv -f /etc/salt/minion /etc/salt/minion.org
    cp files/etc/salt/minion /etc/salt/minion
    systemctl restart salt-minion

    # ensure it works and log the version
    salt-call --version

popd

echo "Running $0 ..."
